---
title: "Poročilo pri predmetu Analiza podatkov s programom R"
author: "Študent FMF"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding = "UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding = "UTF-8")
```

# Izbira teme

Vsebina projekta pri predmetu APPR, ki sem ga izdeloval obsega trgovanje ZDA. V obsegu analize obravnavam izvoz in uvoz ZDA z drugimi državami sveta za obdobje 10let (2006-2015). Za države, ki so med največjimi uvoznicami/izvoznicami z ZDA, sta prikazana uvoz/izvoz nekaj glavnih kategorij produktov in uvoz/izvoz vseh produktov skupaj (celotnega uvoza/izvoza), ki jih uvaža/izvaža ZDA v te države. Podatki so v velikosti tisoč ameriških dolarjih (1000 USD).

Podatki so pridobljeni na spletnih straneh:
- http://en.wikipedia.org/wiki/List_of_the_largest_trading_partners_of_the_United_States;
- http://wits.worldbank.org/CountryProfile/en/Country/USA/StartYear/2006/EndYear/2015/TradeFlow/Import/Indicator/MPRT-TRD-VL/Partner/BY-COUNTRY/Product/Total;
- http://wits.worldbank.org/CountryProfile/en/Country/USA/StartYear/2006/EndYear/2015/TradeFlow/Export/Indicator/XPRT-TRD-VL/Partner/BY-COUNTRY/Product/Total;
- ostale povezave sledijo iz klasifikacije po produktih izmed zadnjih dveh povezav.

Podatki so v obliki HTML in CSV. 


## Plan dela

Namen analize je ugotoviti v katere države ZDA največ izvaža in uvaža, kakšna je trgovska bilanca in koliko ter kako se izvoz in uvoz spreminjata skozi čas v zadnjih letih pri največjih uvoznikih/izvoznikih. Podatke nameravam geografsko tudi prikazati in izvesti analizo razvrščanja na njih.


# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE, message=FALSE}
source("uvoz/uvoz.r", encoding = "UTF-8")
```

Podatke sem uvozil s pomočjo funkcij, ki sem jih napisal tako, da imam podatke ločene za uvoz in izvoz v večih tabelah. V prvotnih tabelah stolpci predstavljajo leto, vrstice pa države s katerimi ZDA trguje. Nato sem sestavil tabeli za celotni uvoz in celotni izvoz, kjer vrstice predstavljajo države (vsaka vrstica za eno leto), stolpci pa kategorije produktov.
Ker podatki ne vsebujejo podatkov za vse države v vseh opazovanih letih, sem podatke očistil tako, da sem poskrbel, da so podatki za vsa leta v določeni kategoriji dosegljivi za določeno državo (kjer je v določeni kategoriji manjkal podatek za kakšno leto, sem celotno obdobje izključil iz analize v tej kategoriji za to državo, saj če manjka en podatek ne moremo spremljati kako se spreminja uvoz/izvoz skozi leta za tisto kategorijo).

1. Tabele uvožene z funkcijo "uvozi.tabelo":

- i. stolpec (character): Partnerji (iz katerih držav ZDA uvaža)
- ii. stolpec (numeric): Leto (2006-2015)
- iii. stolpec (numeric): kategorija (vsi produkti, gorivo, živali,...)

Nato sem na podlagi uvoženih tabel z zgoraj omenjeno funkcijo sestavil tabelo "tabela_uvoz", ki
je sestavljena na naslednji način:

- i. stolpec (character): Partnerji (iz katerih držav ZDA uvaža)
- ii. stolpec (numeric): Leto (2006-2015)
- iii. stolpec (numeric): Vsi produkti (celoten uvoz) 
- iv. stolpec (numeric): Zivali
- v. stolpec (numeric): Zelenjava
- vi. stolpec (numeric): Gorivo
- vii. stolpec (numeric): Plastika in guma
- viii. stolpec (numeric): Les

Sledilo je urejanje tabele "tabela_uvoz" s pomočjo funkcije "ciscenje", ki vzame določen stolpec v tabeli in ga prečiščii tako, da če za katero leto ni podatkov (imamo vrednost NA) funkcija za tisto državo v določeni vrstici (kategoriji) za vsa leta vrne NA. Namen funkcije je, da če nimamo podatkov za državo v določenem letu (izmed 10let) v določeni kategoriji potem jih ne rabimo za nobeno leto, saj ne moremo spremljati spremembe skozi leta.


2. Tabele uvožene z funkcijo "uvozi.tabelo1":

- i. stolpec (character): Partnerji (v katere države ZDA izvaža)
- ii. stolpec (numeric): Leto (2006-2015)
- iii. stolpec (numeric): kategorija (vsi produkti, Gorivo, Zivali,...)

Nato sem na podlagi uvoženih tabel z zgoraj omenjeno funkcijo sestavil tabelo "tabela_izvoz", ki
je sestavljena na naslednji način:

- i. stolpec (character): Partnerji (v katere države ZDA izvaža)
- ii. stolpec (numeric): Leto (2006-2015)
- iii. stolpec (numeric): Vsi produkti (celoten izvoz) 
- iv. stolpec (numeric): Zivali
- v. stolpec (numeric): Zelenjava
- vi. stolpec (numeric): Gorivo
- vii. stolpec (numeric): Plastika in guma
- viii. stolpec (numeric): Les

Sledilo je urejanje tabele "tabela_izvoz" s pomočjo funkcije "ciscenje".


3. Tabela "tabela_partnerstvo_izvoz":

- i. stolpec (character): Države (za katere je ZDA njihov največji izvoznik za podatke iz leta 2014)
- ii. stolpec (numeric): Procent (višina izvoza ZDA iz določene države v %)


4. Tabela "tabela_partnerstvo_uvoz":

- i. stolpec (character): Države (za katere je ZDA njihov največji uvoznik za podatke iz leta 2014)
- ii. stolpec (numeric): Procent (višina uvoza ZDA iz določene države v %)


Za zgled si oglejmo začetka obeh glavnih tabel ("tabela_uvoz" in "tabela_izvoz"):

```{r razpredelnice}
kable(head(tabela_uvoz), caption = "Tabela uvoza ZDA v države sveta za obdobje 2006-2015" )

kable(head(tabela_izvoz), caption = "Tabela izvoza ZDA iz držav sveta za obdobje 2006-2015")
```



# Vizualizacija in analiza podatkov

```{r vizualizacija, echo=FALSE, message=FALSE}
source("vizualizacija/vizualizacija.r", encoding = "UTF-8")
```
```{r analiza, echo=FALSE, message=FALSE}
source("analiza/analiza.r", encoding = "UTF-8")
```










Slika \ref{fig:zemljevid} prikazuje povprečno velikost družine za vsako občino.

```{r zemljevid, echo=FALSE, fig.align='center', fig.cap='Zemljevid povprečnega števila otrok v družini'}
ggplot() + geom_polygon(data = left_join(zemljevid, povprecja, by = c("OB_UIME" = "obcina")),
                        aes(x = long, y = lat, group = group, fill = povprecje)) +
  ggtitle("Povprečno število otrok v družini") + xlab("") + ylab("") +
  guides(fill = guide_colorbar(title = "Povprečje"))
```



Slika \ref{fig:graf} prikazuje povezavo med številom naselij in površino občine.

```{r graf, echo=FALSE, fig.align='center', fig.cap='Povezava med številom naselij in površino občine'}
ggplot(inner_join(obcine, data.frame(obcina = names(skupine),
                                     skupina = factor(skupine)), by = "obcina")
, aes(x = povrsina, y = naselja, color = skupina, size = prebivalci/1000)) + geom_point() +
  ggtitle("Število naselij glede na površino občine") +
  xlab(expression("Površina (km"^2 * ")")) + ylab("Št. naselij") +
  guides(color = guide_legend(title = "Skupina"),
         size = guide_legend(title = "Prebivalci (* 1000)"))
```

***

```{r shiny, echo = FALSE}
shinyAppDir("shiny", options=list(width="100%", height=600))
```
